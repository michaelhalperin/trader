<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bybit Trading Bot Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .status-bar {
        display: flex;
        justify-content: space-around;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .status-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        min-width: 150px;
        margin: 10px;
      }

      .status-card .subtitle {
        font-size: 0.8em;
        color: #888;
        margin-top: 5px;
      }

      .status-card h3 {
        color: #666;
        margin-bottom: 10px;
        font-size: 0.9em;
      }

      .status-card .value {
        font-size: 1.5em;
        font-weight: bold;
      }

      .status-running {
        color: #28a745;
      }
      .status-stopped {
        color: #dc3545;
      }
      .status-flat {
        color: #6c757d;
      }
      .status-long {
        color: #28a745;
      }
      .status-short {
        color: #dc3545;
      }
      .pnl-positive {
        color: #28a745;
      }
      .pnl-negative {
        color: #dc3545;
      }

      .transactions {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .transactions h2 {
        margin-bottom: 20px;
        color: #333;
      }

      .transaction-table {
        width: 100%;
        border-collapse: collapse;
      }

      .transaction-table th,
      .transaction-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .transaction-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #555;
      }

      .transaction-table tr:hover {
        background: #f8f9fa;
      }

      .signal-buy {
        background: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
      }

      .signal-sell {
        background: #f8d7da;
        color: #721c24;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
      }

      .signal-close_long {
        background: #fff3cd;
        color: #856404;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
      }

      .signal-stop_loss {
        background: #f8d7da;
        color: #721c24;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
      }

      .signal-take_profit {
        background: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
      }

      .percentage {
        font-weight: bold;
        font-size: 0.9em;
      }

      .percentage-positive {
        color: #28a745;
      }

      .percentage-negative {
        color: #dc3545;
      }

      .money-used {
        font-weight: bold;
        color: #2c3e50;
        background-color: #ecf0f1;
        border-radius: 4px;
        padding: 2px 6px;
      }

      .trade-details {
        font-size: 0.85em;
        color: #666;
        margin-top: 5px;
      }

      .sma-indicators {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
      }

      .sma-value {
        background: #f8f9fa;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
      }

      .sma-fast {
        border-left: 3px solid #28a745;
      }

      .sma-slow {
        border-left: 3px solid #dc3545;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .no-transactions {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .status-bar {
          flex-direction: column;
        }

        .transaction-table {
          font-size: 0.9em;
        }

        .transaction-table th,
        .transaction-table td {
          padding: 8px 4px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸ¤– Bybit Trading Bot Dashboard</h1>
        <p>Real-time monitoring of SMA Crossover Strategy</p>
      </div>

      <div class="status-bar">
        <div class="status-card">
          <h3>Bot Status</h3>
          <div class="value" id="bot-status">Loading...</div>
        </div>

        <div class="status-card">
          <h3>Current Position</h3>
          <div class="value" id="position">Loading...</div>
        </div>

        <div class="status-card">
          <h3>Equity (USDT)</h3>
          <div class="value" id="equity">Loading...</div>
        </div>

        <div class="status-card">
          <h3>Daily P&L</h3>
          <div class="value" id="daily-pnl">Loading...</div>
          <div class="subtitle" id="daily-pnl-pct">Loading...</div>
        </div>

        <div class="status-card">
          <h3>Last Signal</h3>
          <div class="value" id="last-signal">Loading...</div>
          <div class="subtitle" id="signal-time">Loading...</div>
        </div>

        <div class="status-card">
          <h3>SMA Indicators</h3>
          <div class="sma-indicators">
            <div class="sma-value sma-fast" id="sma-fast">SMA5: Loading...</div>
            <div class="sma-value sma-slow" id="sma-slow">
              SMA20: Loading...
            </div>
          </div>
        </div>
      </div>

      <div class="transactions">
        <h2>ðŸ“Š Recent Transactions</h2>
        <div id="transactions-container">
          <div class="loading">Loading transactions...</div>
        </div>
      </div>
    </div>

    <script>
      function updateStatus() {
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            // Update status cards
            document.getElementById("bot-status").textContent = data.status;
            document.getElementById(
              "bot-status"
            ).className = `value status-${data.status}`;

            document.getElementById("position").textContent =
              data.current_position;
            document.getElementById(
              "position"
            ).className = `value status-${data.current_position}`;

            document.getElementById(
              "equity"
            ).textContent = `$${data.equity.toFixed(2)}`;

            const pnlElement = document.getElementById("daily-pnl");
            const pnlValue = parseFloat(data.daily_pnl || 0);
            pnlElement.textContent = `$${pnlValue.toFixed(2)}`;
            pnlElement.className = `value ${
              pnlValue >= 0 ? "pnl-positive" : "pnl-negative"
            }`;

            document.getElementById("last-signal").textContent =
              data.last_signal || "None";

            // Calculate daily P&L percentage
            const startEquity = parseFloat(
              data.daily_start_equity || data.equity || 1000
            );
            const pnlPct = startEquity > 0 ? (pnlValue / startEquity) * 100 : 0;
            const pnlPctElement = document.getElementById("daily-pnl-pct");
            pnlPctElement.textContent = `${pnlPct.toFixed(2)}%`;
            pnlPctElement.className = `subtitle ${
              pnlPct >= 0 ? "percentage-positive" : "percentage-negative"
            }`;

            // Update signal time
            const signalTimeElement = document.getElementById("signal-time");
            if (data.last_signal_time) {
              const signalTime = new Date(
                data.last_signal_time
              ).toLocaleString();
              signalTimeElement.textContent = signalTime;
            } else {
              signalTimeElement.textContent = "No recent signals";
            }

            // Update SMA indicators
            if (data.sma_fast && data.sma_slow) {
              document.getElementById(
                "sma-fast"
              ).textContent = `SMA5: $${data.sma_fast.toFixed(2)}`;
              document.getElementById(
                "sma-slow"
              ).textContent = `SMA20: $${data.sma_slow.toFixed(2)}`;
            }
          })
          .catch((error) => {
            console.error("Error fetching status:", error);
          });
      }

      function updateTransactions() {
        fetch("/api/transactions")
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("transactions-container");

            if (data.transactions.length === 0) {
              container.innerHTML =
                '<div class="no-transactions">No transactions yet</div>';
              return;
            }

            let html = `
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Signal</th>
                                    <th>Side</th>
                               <th>Price</th>
                               <th>Size</th>
                               <th>Trade Value</th>
                               <th>Your Money Used</th>
                               <th>P&L</th>
                               <th>P&L %</th>
                               <th>SL/TP</th>
                               <th>Order ID</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

            data.transactions
              .slice(-20)
              .reverse()
              .forEach((tx) => {
                const time = new Date(tx.timestamp).toLocaleString();
                const signalClass = `signal-${tx.signal}`;
                const pnl = parseFloat(tx.pnl_usdt || 0);
                const pnlClass = pnl >= 0 ? "pnl-positive" : "pnl-negative";
                const price = parseFloat(tx.executed_price || 0);
                const size = parseFloat(tx.executed_size || 0);
                const tradeValue = parseFloat(tx.trade_value_usd || 0);
                const sl = parseFloat(tx.stop_loss || 0);
                const tp = parseFloat(tx.take_profit || 0);

                // Calculate money used from your account
                // If trade_value_usd is not available, calculate it from price * size
                const moneyUsed = tradeValue > 0 ? tradeValue : (price * size);

                // Calculate P&L percentage
                let pnlPct = 0;
                if (pnl !== 0 && moneyUsed > 0) {
                  pnlPct = (pnl / moneyUsed) * 100;
                }

                // Format SL/TP
                let slTpText = "-";
                if (sl > 0 && tp > 0) {
                  slTpText = `SL: $${sl.toFixed(2)}<br/>TP: $${tp.toFixed(2)}`;
                }

                html += `
                                             <tr>
                                                 <td>${time}</td>
                                                 <td><span class="${signalClass}">${
                  tx.signal
                }</span></td>
                                                 <td>${tx.side}</td>
                                                 <td>$${price.toFixed(2)}</td>
                                                 <td>${size.toFixed(6)}</td>
                                                <td>$${moneyUsed.toFixed(2)}</td>
                                                <td class="money-used">$${moneyUsed.toFixed(
                                                  2
                                                )}</td>
                                                 <td class="${pnlClass}">${
                  pnl !== 0 ? `$${pnl.toFixed(2)}` : "-"
                }</td>
                                                 <td class="${pnlClass}">${
                  pnlPct !== 0 ? `${pnlPct.toFixed(2)}%` : "-"
                }</td>
                                                 <td>${slTpText}</td>
                                                 <td>${tx.order_id || "-"}</td>
                                             </tr>
                                         `;
              });

            html += "</tbody></table>";
            container.innerHTML = html;
          })
          .catch((error) => {
            console.error("Error fetching transactions:", error);
          });
      }

      // Update every 2 seconds
      setInterval(() => {
        updateStatus();
        updateTransactions();
      }, 2000);

      // Initial load
      updateStatus();
      updateTransactions();
    </script>
  </body>
</html>
